// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public"]
}

enum UserRole {
  STUDENT
  TUTOR
  ADMIN

  @@schema("public")
}

model User {
  id            String  @id @default(uuid())
  email         String  @unique
  name          String?
  programme     String?
  matricNo      String? @unique
  matricCardUrl String?
  passwordHash  String

  role            UserRole             @default(STUDENT)
  roleAssignments UserRoleAssignment[]

  isTutorApproved Boolean  @default(false)
  createdAt       DateTime @default(now())
  avatarUrl       String?

  tutorApplications TutorApplication[]
  studentSessions   Session[]          @relation("StudentSessions")
  tutorSessions     Session[]          @relation("TutorSessions")

  verificationStatus String  @default("PENDING_REVIEW")
  ocrText            String?
  ocrMatchedMatric   Boolean @default(false)
  ocrMatchedName     Boolean @default(false)

  isDeactivated           Boolean        @default(false)
  deactivatedAt           DateTime?
  deactivationReason      String?
  deactivationReasonOther String?
  tutorSubjects           TutorSubject[]

  notifications Notification[]

  avgRating   Float @default(0)
  ratingCount Int   @default(0)

  ratingsReceived SessionRating[] @relation("TutorRatings")
  ratingsGiven    SessionRating[] @relation("StudentRatings")

  chatChannelsAsStudent ChatChannel[] @relation("ChatStudent")
  chatChannelsAsTutor   ChatChannel[] @relation("ChatTutor")
  chatMessagesSent      ChatMessage[] @relation("ChatSender")
  chatReads             ChatRead[]    @relation("ChatReader")

  subjectProgress StudentSubjectProgress[]
  topicProgress   StudentTopicProgress[]

  pointsWallet        PointsWallet?
  pointsTransactions  PointsTransaction[]
  userBadges          UserBadge[]
  rewardRedemptions   RewardRedemption[]

  @@schema("public")
}

model UserRoleAssignment {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  role      UserRole
  createdAt DateTime @default(now())

  @@unique([userId, role]) // prevents duplicates
  @@schema("public")
}

model TutorApplication {
  id              String    @id @default(cuid())
  user            User      @relation(fields: [userId], references: [id])
  userId          String
  subjects        String
  cgpa            Float?
  availability    String?
  status          String    @default("PENDING") // PENDING | APPROVED | REJECTED
  createdAt       DateTime  @default(now())
  reviewedAt      DateTime?
  rejectionReason String?
  transcriptPath  String?

  @@schema("public")
}

enum SessionStatus {
  PENDING
  ACCEPTED
  COMPLETED
  CANCELLED

  @@schema("public")
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  REJECTED

  @@schema("public")
}

model Subject {
  id        String   @id @default(cuid())
  code      String   @unique // e.g. WIA2003
  title     String // e.g. Data Structures
  aliases   String? // optional CSV: "DSA,Data Structure"
  createdAt DateTime @default(now())

  tutorLinks TutorSubject[]
  sessions   Session[]

  topics                 Topic[]
  progress               StudentSubjectProgress[]
  studentTopicProgresses StudentTopicProgress[]

  @@schema("public")
}

model TutorSubject {
  id        String   @id @default(cuid())
  tutor     User     @relation(fields: [tutorId], references: [id])
  tutorId   String
  subject   Subject  @relation(fields: [subjectId], references: [id])
  subjectId String
  createdAt DateTime @default(now())

  @@unique([tutorId, subjectId])
  @@schema("public")
}

model Session {
  id String @id @default(cuid())

  student   User   @relation("StudentSessions", fields: [studentId], references: [id])
  studentId String

  tutor   User?   @relation("TutorSessions", fields: [tutorId], references: [id])
  tutorId String?

  subject   Subject @relation(fields: [subjectId], references: [id])
  subjectId String

  scheduledAt DateTime
  durationMin Int       @default(60)
  endsAt      DateTime?

  chatChannel ChatChannel? @relation("SessionChatChannel")

  status SessionStatus @default(PENDING)

  notes         String?
  cancelledAt   DateTime?
  cancelReason  String?
  rescheduledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ---- reschedule proposal flow (tutor -> student confirm) ----
  proposedAt       DateTime?
  proposedEndAt    DateTime?
  proposedNote     String?
  proposalStatus   ProposalStatus?
  proposedByUserId String?

  studentReminderEmailId String?
  tutorReminderEmailId   String?

  calendarUid      String?        @unique
  calendarSequence Int            @default(0)
  sessionRating    SessionRating?

  completion SessionCompletion?
  review SessionReview?
  completedAt DateTime?

  @@index([studentId, status])
  @@index([tutorId, status])
  @@index([scheduledAt])
  @@schema("public")
}

enum NotificationStatus {
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED

  @@schema("public")
}

model Notification {
  id     String             @id @default(cuid())
  userId String
  type   String
  title  String
  body   String
  data   Json?
  status NotificationStatus @default(QUEUED)

  createdAt DateTime  @default(now())
  sentAt    DateTime?
  readAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  dedupeKey String? @db.VarChar(120)

  @@unique([userId, dedupeKey])
  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([userId, status])
  @@schema("public")
}

model ChatChannel {
  id        String @id @default(uuid())
  sessionId String @unique
  studentId String
  tutorId   String

  createdAt     DateTime @default(now())
  lastMessageAt DateTime @default(now())

  session Session @relation("SessionChatChannel", fields: [sessionId], references: [id], onDelete: Cascade)
  student User    @relation("ChatStudent", fields: [studentId], references: [id], onDelete: Cascade)
  tutor   User    @relation("ChatTutor", fields: [tutorId], references: [id], onDelete: Cascade)

  messages ChatMessage[]
  reads    ChatRead[]

  closeAt  DateTime? // when it should auto-close
  closedAt DateTime? // when it actually closed

  @@index([studentId])
  @@index([tutorId])
  @@index([lastMessageAt])
  @@schema("public")
}

model ChatMessage {
  id        String @id @default(uuid())
  channelId String
  senderId  String
  text      String

  createdAt DateTime @default(now())

  channel ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  sender  User        @relation("ChatSender", fields: [senderId], references: [id], onDelete: Cascade)

  attachments ChatAttachment[]

  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  @@index([channelId, createdAt])
  @@index([senderId])
  @@schema("public")
}

model ChatRead {
  id         String   @id @default(uuid())
  channelId  String
  userId     String
  lastReadAt DateTime @default(now())

  channel ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    User        @relation("ChatReader", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@index([userId])
  @@schema("public")
}

model ChatAttachment {
  id        String @id @default(uuid())
  messageId String

  bucket     String @default("chat-attachments")
  objectPath String

  fileName    String
  contentType String
  sizeBytes   Int

  createdAt DateTime @default(now())

  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@schema("public")
}

model ChatTyping {
  id        String   @id @default(uuid())
  channelId String
  userId    String
  isTyping  Boolean  @default(false)
  updatedAt DateTime @updatedAt

  @@unique([channelId, userId])
  @@schema("public")
}

model SessionRating {
  id String @id @default(cuid())

  sessionId String @unique
  studentId String
  tutorId   String

  rating  Int // 1..5
  comment String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  confirmed Boolean? 

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  tutor User @relation("TutorRatings", fields: [tutorId], references: [id], onDelete: Cascade)

  student User @relation("StudentRatings", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([tutorId])
  @@index([studentId])
  @@schema("public")
}

model SessionCompletion {
  id        String  @id @default(cuid())
  sessionId String  @unique
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  summary          String
  confidenceBefore Int
  confidenceAfter  Int

  nextSteps String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  topics SessionTopic[]

  @@schema("public")
}

model Topic {
  id        String  @id @default(cuid())
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  name      String
  createdAt DateTime @default(now())

  sessionTopics   SessionTopic[]
  studentProgress StudentTopicProgress[]

  @@unique([subjectId, name])
  @@index([subjectId])
  @@schema("public")
}

model SessionTopic {
  id           String            @id @default(cuid())
  completionId String
  completion   SessionCompletion @relation(fields: [completionId], references: [id], onDelete: Cascade)

  topicId String
  topic   Topic  @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([completionId, topicId])
  @@index([topicId])
  @@schema("public")
}

model StudentSubjectProgress {
  id        String @id @default(cuid())
  studentId String
  subjectId String

  totalSessions Int       @default(0)
  totalMinutes  Int       @default(0)
  lastSessionAt DateTime?
  avgConfGain   Float     @default(0)

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  student User    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([studentId, subjectId])
  @@index([studentId])
  @@index([subjectId])
  @@schema("public")
}

model StudentTopicProgress {
  id        String @id @default(cuid())
  studentId String
  subjectId String
  topicId   String

  timesCovered  Int       @default(0)
  lastCoveredAt DateTime?

  student User    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  topic   Topic   @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([studentId, topicId])
  @@index([studentId, subjectId])
  @@schema("public")
}

model SessionReview {
  id          String   @id @default(cuid())
  sessionId   String   @unique
  studentId   String
  tutorId     String

  rating      Int      // 1..5
  feedback    String?  // optional
  confirmed   Boolean? // optional: null = not answered, true/false = student confirmed/denied

  createdAt   DateTime @default(now())

  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([tutorId])

  @@schema("public")
}

enum PointsType {
  EARN
  REDEEM
  BONUS
  PENALTY

  @@schema("public")
}

model PointsWallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  total     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])

  @@schema("public")
}

model PointsTransaction {
  id          String     @id @default(cuid())
  userId      String
  type        PointsType
  amount      Int
  description String
  sessionId   String?
  createdAt   DateTime   @default(now())

  user        User       @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([sessionId])

  @@schema("public")
}

model Badge {
  id          String   @id @default(cuid())
  key         String   @unique // e.g. "FIRST_SESSION"
  name        String
  description String
  icon        String   // e.g. "trophy"
  createdAt   DateTime @default(now())

  userBadges UserBadge[]

  @@schema("public")
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  awardedAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  badge     Badge    @relation(fields: [badgeId], references: [id])

  @@unique([userId, badgeId])

  @@schema("public")
}

model Reward {
  id          String   @id @default(cuid())
  name        String
  description String
  pointsCost  Int
  stock       Int?
  createdAt   DateTime @default(now())

  redemptions RewardRedemption[]

  @@schema("public")
}

model RewardRedemption {
  id        String   @id @default(cuid())
  userId    String
  rewardId  String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  reward    Reward   @relation(fields: [rewardId], references: [id])

  @@index([userId, createdAt])

  @@schema("public")
}